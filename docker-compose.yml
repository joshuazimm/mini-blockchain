services:
  cpp-builder:
    build:
      context: .
      dockerfile: builder.dockerfile
    volumes:
      - ./build:/output
    command: >
      sh -c "cp /src/build/mini_blockchain /output/ && echo 'Binary copied'"
    restart: "no"

  cpp-runner:
    build:
      context: .
      dockerfile: runner.dockerfile
    depends_on:
      - cpp-builder
    networks:
      - my_network
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: "0.5"  # Allocate 50% of a CPU to each container replica
          memory: 1G    # Allocate 1 GB of memory to each replica
        reservations:
          cpus: "0.2"  # Reserve 20% of a CPU per replica
          memory: 500M  # Reserve 500 MB of memory per replica
    restart: "no"

networks:
  my_network:
    driver: bridge